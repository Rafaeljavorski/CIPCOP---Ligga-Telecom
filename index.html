<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atendimento COP - Ligga Telecom</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Atendimento COP - Ligga Telecom</h1>

  <div id="contadores">
    <div class="contador aguardando">ğŸ•“ Aguardando: <strong id="contadorAguardando">0</strong></div>
    <div class="contador confirmado">âœ… Confirmado: <strong id="contadorConfirmado">0</strong></div>
    <div class="contador reagendado">ğŸ“… Reagendado: <strong id="contadorReagendado">0</strong></div>
    <div class="contador cancelado">âŒ Cancelado: <strong id="contadorCancelado">0</strong></div>
  </div>

  <div class="painel">
    <input type="file" id="fileInput" accept=".csv">
    <input type="text" id="filtroContrato" placeholder="Buscar contrato...">
    <button id="btnExportar">Exportar CSV</button>
    <button id="btnLimparSelecionados">ğŸ§¹ Limpar Selecionados</button>
    <button id="btnEnviarSelecionados">ğŸ“¤ Enviar Selecionados</button>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Selecionar</th>
        <th>Contrato</th>
        <th>Cliente</th>
        <th>Celular</th>
        <th>Data Agendamento</th>
        <th>EndereÃ§o</th>
        <th>Bairro</th>
        <th>PerÃ­odo</th>
        <th>Status</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody id="tabelaBody"></tbody>
  </table>

  <script>
    let dados = [];

    document.getElementById("fileInput").addEventListener("change", handleFileUpload);
    document.getElementById("filtroContrato").addEventListener("input", filtrarTabela);
    document.getElementById("btnExportar").addEventListener("click", exportarCSV);
    document.getElementById("btnLimparSelecionados").addEventListener("click", limparSelecionados);
    document.getElementById("btnEnviarSelecionados").addEventListener("click", enviarSelecionados);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return alert("Nenhum arquivo selecionado.");

      const reader = new FileReader();
      reader.onload = function (e) {
        const linhas = e.target.result.split("\n").map(l => l.trim()).filter(l => l);
        const cabecalho = linhas[0].split(",");
        const indices = {
          contrato: cabecalho.indexOf("Contrato"),
          cliente: cabecalho.indexOf("Cliente"),
          celular: cabecalho.indexOf("Celular"),
          data: cabecalho.indexOf("Data Agendamento"),
          endereco: cabecalho.indexOf("EndereÃ§o"),
          bairro: cabecalho.indexOf("Bairro")
        };

        dados = linhas.slice(1).map(l => {
          const cols = l.split(",");
          return {
            contrato: cols[indices.contrato] || "",
            cliente: cols[indices.cliente] || "",
            celular: cols[indices.celular] || "",
            data: cols[indices.data] || "",
            endereco: cols[indices.endereco] || "",
            bairro: cols[indices.bairro] || "",
            periodo: "Tarde",
            status: "Aguardando",
            selecionado: false
          };
        }).filter(d => d.contrato && d.celular);

        atualizarTabela();
        atualizarContadores();
        alert("âœ… Planilha importada com sucesso!");
      };

      reader.readAsText(file, "UTF-8");
    }

    function atualizarTabela() {
      const body = document.getElementById("tabelaBody");
      body.innerHTML = "";

      dados.forEach((d, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" ${d.selecionado ? "checked" : ""} onchange="toggleSelecionado(${i})"></td>
          <td>${d.contrato}</td>
          <td>${d.cliente}</td>
          <td>${d.celular}</td>
          <td>${d.data}</td>
          <td>${d.endereco}</td>
          <td>${d.bairro}</td>
          <td>
            <select id="periodo_${i}" onchange="alterarPeriodo(${i}, this.value)">
              <option ${d.periodo === "ManhÃ£" ? "selected" : ""}>ManhÃ£</option>
              <option ${d.periodo === "Tarde" ? "selected" : ""}>Tarde</option>
              <option ${d.periodo === "Noite" ? "selected" : ""}>Noite</option>
            </select>
          </td>
          <td>${d.status}</td>
          <td>
            <button onclick="previewMensagem(${i})">ğŸ‘ PrÃ©via</button>
            <button onclick="enviarPara(${i})">ğŸ“¤ Enviar</button>
            <button onclick="alterarStatus(${i}, 'Confirmado')">âœ…</button>
            <button onclick="alterarStatus(${i}, 'Reagendado')">ğŸ“…</button>
            <button onclick="alterarStatus(${i}, 'Cancelado')">âŒ</button>
          </td>
        `;
        body.appendChild(row);
      });
    }

    function atualizarContadores() {
      const aguardando = dados.filter(d => d.status === "Aguardando").length;
      const confirmado = dados.filter(d => d.status === "Confirmado").length;
      const reagendado = dados.filter(d => d.status === "Reagendado").length;
      const cancelado = dados.filter(d => d.status === "Cancelado").length;

      document.getElementById("contadorAguardando").innerText = aguardando;
      document.getElementById("contadorConfirmado").innerText = confirmado;
      document.getElementById("contadorReagendado").innerText = reagendado;
      document.getElementById("contadorCancelado").innerText = cancelado;
    }

    function toggleSelecionado(i) {
      dados[i].selecionado = !dados[i].selecionado;
    }

    function alterarPeriodo(i, valor) {
      dados[i].periodo = valor;
    }

    function alterarStatus(i, status) {
      dados[i].status = status;
      atualizarTabela();
      atualizarContadores();
    }

    function filtrarTabela() {
      const filtro = document.getElementById("filtroContrato").value.toLowerCase();
      const linhas = document.querySelectorAll("#tabelaBody tr");
      linhas.forEach(l => {
        const contrato = l.children[1].innerText.toLowerCase();
        l.style.display = contrato.includes(filtro) ? "" : "none";
      });
    }

    function previewMensagem(i) {
      const d = dados[i];
      const tipo = prompt("Escolha o tipo de mensagem:\n1 - AntecipaÃ§Ã£o\n2 - ConfirmaÃ§Ã£o\n3 - TÃ©cnico no local", "1");
      alert("ğŸ“© PrÃ©via:\n\n" + gerarMensagem(d, tipo));
    }

    function gerarMensagem(d, tipo) {
      switch (tipo) {
        case "1":
          return `OlÃ¡, Prezado(a) Cliente Ligga!\nAqui Ã© do agendamento da Ligga Telecom, tudo bem? ğŸ˜Š\n\nIdentificamos a oportunidade de antecipar o seu atendimento para hoje!\n\nğŸ“… Data: ${d.data}\nâ° PerÃ­odo: ${d.periodo}\n\nPodemos confirmar a antecipaÃ§Ã£o?\n1ï¸âƒ£ Confirmar\n2ï¸âƒ£ Permanecer data atual\n(Nosso sistema nÃ£o suporta chamadas e Ã¡udios)`;
        case "2":
          return `OlÃ¡, tudo bem?\nMeu contato Ã© referente Ã  ConfirmaÃ§Ã£o de Agendamento â€“ InstalaÃ§Ã£o de Internet | Ligga Telecom.\n\nğŸ“… Agendado: ${d.data}\n\n1ï¸âƒ£ Confirmar atendimento\n2ï¸âƒ£ Preciso reagendar\n3ï¸âƒ£ JÃ¡ cancelei os serviÃ§os\n\nAguardamos sua resposta!\nEquipe Ligga Telecom.`;
        case "3":
          return `Um tÃ©cnico a serviÃ§o da Ligga Telecom estÃ¡ em frente Ã  sua residÃªncia para realizar a visita tÃ©cnica.\n\nâš ï¸ Pedimos que haja alguÃ©m maior de 18 anos no local durante o atendimento. âš ï¸`;
        default:
          return "";
      }
    }

    // âœ… Corrigido â€” usa wa.me com fallback para garantir texto
    function enviarPara(i) {
      const d = dados[i];
      const msg = gerarMensagem(d, "2");
      const numero = d.celular.replace(/\D/g, "");
      const link = `https://wa.me/55${numero}?text=${encodeURIComponent(msg)}`;

      try {
        const a = document.createElement("a");
        a.href = link;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        setTimeout(() => {
          if (document.visibilityState !== "hidden") {
            navigator.clipboard.writeText(msg);
            alert("âš ï¸ O WhatsApp abriu sem texto.\nA mensagem foi copiada â€” basta colar no campo de envio.");
          }
        }, 1500);
      } catch (e) {
        navigator.clipboard.writeText(msg);
        alert("âš ï¸ NÃ£o foi possÃ­vel abrir o WhatsApp.\nMensagem copiada â€” cole manualmente no app.");
      }

      alterarStatus(i, "Confirmado");
    }

    function enviarSelecionados() {
      const selecionados = dados.filter(d => d.selecionado);
      if (selecionados.length === 0) return alert("Nenhum contrato selecionado.");

      selecionados.forEach(d => {
        const msg = gerarMensagem(d, "2");
        const numero = d.celular.replace(/\D/g, "");
        const link = `https://wa.me/55${numero}?text=${encodeURIComponent(msg)}`;

        const a = document.createElement("a");
        a.href = link;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    }

    function limparSelecionados() {
      dados = dados.filter(d => !d.selecionado);
      atualizarTabela();
      atualizarContadores();
    }

    function exportarCSV() {
      const linhas = [
        ["Contrato", "Cliente", "Celular", "Data Agendamento", "EndereÃ§o", "Bairro", "PerÃ­odo", "Status"],
        ...dados.map(d => [d.contrato, d.cliente, d.celular, d.data, d.endereco, d.bairro, d.periodo, d.status])
      ];
      const csv = linhas.map(l => l.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "atendimento_cop_ligga.csv";
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
