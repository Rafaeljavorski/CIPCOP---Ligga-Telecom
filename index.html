<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Atendimento *COP* - Ligga Telecom</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{
    --primary:#2563eb;
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#0b1220;
    --ok:#16a34a;
    --warn:#f59e0b;
    --err:#ef4444;
    --info:#3b82f6;
  }
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:18px;color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto}
  h1{color:var(--primary);text-align:center;margin-bottom:12px}
  .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{padding:8px;border-radius:8px;border:1px solid #d1d5db}
  button{background:var(--primary);color:#fff;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--primary);border:1px solid var(--primary)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px;vertical-align:middle}
  th{background:var(--primary);color:#fff;position:sticky;top:0}
  tr:nth-child(even){background:#fbfdff}
  .stats{display:flex;gap:12px;justify-content:center;margin-bottom:8px;flex-wrap:wrap}
  .card{background:var(--card);padding:10px 14px;border-radius:10px;min-width:140px;text-align:center;box-shadow:0 2px 6px rgba(2,6,23,0.04)}
  .card small{display:block;color:#64748b}
  #contAguardando { color: var(--info); font-weight:700; font-size:18px }
  #contConfirmado { color: var(--ok); font-weight:700; font-size:18px }
  #contReagendado { color: var(--warn); font-weight:700; font-size:18px }
  #contCancelado { color: var(--err); font-weight:700; font-size:18px }
  textarea#mensagemPadrao{width:100%;min-height:110px;margin-top:8px}
  .small{font-size:13px;padding:6px 8px;border-radius:8px}
  .checkbox-center{text-align:center}
  .sel-col{width:40px;text-align:center}
  .actions button{padding:6px 8px}
  @media(max-width:900px){ .row{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Atendimento COP - Ligga Telecom</h1>

  <!-- Contadores coloridos -->
  <div class="row panel stats">
    <div class="card"><small>Aguardando</small><div id="contAguardando">0</div></div>
    <div class="card"><small>Confirmados</small><div id="contConfirmado">0</div></div>
    <div class="card"><small>Reagendados</small><div id="contReagendado">0</div></div>
    <div class="card"><small>Cancelados</small><div id="contCancelado">0</div></div>
  </div>

  <!-- Controles / Formul√°rio -->
  <div class="panel">
    <div class="row" style="align-items:center">
      <input id="inputCliente" placeholder="Nome do Cliente"/>
      <input id="inputCelular" placeholder="Celular (somente n√∫meros)"/>
      <input id="inputContrato" placeholder="Contrato"/>
      <input id="inputData" type="date"/>
      <input id="inputEndereco" placeholder="Endere√ßo"/>
      <input id="inputBairro" placeholder="Bairro"/>
      <button onclick="adicionarCliente()">‚ûï Adicionar</button>
    </div>

    <div class="row" style="margin-top:8px;align-items:center;">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="usarMesmaAba"> Usar mesma aba do WhatsApp
      </label>

      <select id="tipoMensagem" onchange="atualizarMensagemPadrao()" class="small">
        <option value="antecipacao">Mensagem de Antecipa√ß√£o</option>
        <option value="confirmacao">Mensagem de Confirma√ß√£o</option>
        <option value="chegada">Aviso Chegada T√©cnico</option>
      </select>

      <button class="ghost small" onclick="document.getElementById('arquivoCSV').click()">üì• Importar CSV</button>
      <input id="arquivoCSV" type="file" accept=".csv" style="display:none" onchange="importarCSV(event)">

      <input id="filtroContrato" placeholder="Buscar por contrato (ex: 12345)" style="margin-left:8px;" oninput="filtrarTabela()"/>

      <button class="small" onclick="selecionarTodosToggle()">‚òëÔ∏è Selecionar Todos</button>
      <button class="small" onclick="enviarSelecionados()">üí¨ Enviar Selecionados</button>
      <button class="small" onclick="exportarCSV()">üìä Exportar Selecionados</button>
      <button class="small" onclick="limparSelecionados()">üóëÔ∏è Excluir Selecionados</button>
      <button class="ghost small" onclick="limparTodos()">üßπ Limpar Tudo</button>
    </div>

    <div style="margin-top:10px">
      <textarea id="mensagemPadrao" placeholder="Mensagem (use [NOME], [DATA], [PERIODO], [ENDERECO], [CONTRATO], [BAIRRO])"></textarea>
      <div style="font-size:13px;color:#475569;margin-top:6px">Edite a mensagem padr√£o aqui. Placeholders ser√£o substitu√≠dos ao enviar.</div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="panel" style="overflow:auto">
    <table id="tabela">
      <thead>
        <tr>
          <th class="sel-col checkbox-center"><input id="selTodosTop" type="checkbox" onchange="toggleSelecionarTodosTop(this)"/></th>
          <th>Contrato</th>
          <th>Cliente</th>
          <th>Celular</th>
          <th>Data</th>
          <th>Per√≠odo</th>
          <th>Endere√ßo</th>
          <th>Bairro</th>
          <th>Status</th>
          <th style="min-width:160px">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ================= Persist√™ncia e dados ================= */
const STORAGE_KEY = 'atendimento_cop_v_final_v2';
let clientes = [];
let filtroTexto = '';

function salvarLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(clientes)); }
function carregarLocal(){ const s = localStorage.getItem(STORAGE_KEY); clientes = s ? JSON.parse(s) : []; atualizarTabela(); }
window.addEventListener('load', ()=>{ carregarLocal(); atualizarMensagemPadrao(); });

/* ================= Utilit√°rios ================= */
function e(v){ return v===null||v===undefined ? '' : v.toString(); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatDateForMessage(value){
  if(!value) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(value)){ const [y,m,d]=value.split('-'); return `${d}/${m}/${y}`; }
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(value)) return value;
  const d = new Date(value); if(!isNaN(d)) return d.toLocaleDateString('pt-BR'); return value;
}
function parseDateCSV(val){
  if(!val) return '';
  val = val.toString().trim();
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(val)){
    const parts = val.split('/');
    return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
  const d = new Date(val);
  if(!isNaN(d)) return d.toISOString().slice(0,10);
  return '';
}

/* ================= Adicionar cliente manualmente ================= */
function adicionarCliente(){
  const nome = document.getElementById('inputCliente').value.trim();
  const celular = (document.getElementById('inputCelular').value||'').replace(/\D/g,'');
  const contrato = document.getElementById('inputContrato').value.trim();
  const data = document.getElementById('inputData').value || '';
  const endereco = document.getElementById('inputEndereco').value.trim();
  const bairro = document.getElementById('inputBairro').value.trim();

  if(!nome || !celular || !contrato || !data || !endereco){
    return alert('Preencha: Nome, Celular, Contrato, Data e Endere√ßo.');
  }
  // opcional: prevenir duplica√ß√£o por contrato
  if(contrato && clientes.some(c => c.contrato === contrato)){
    if(!confirm('J√° existe esse contrato. Deseja adicionar mesmo assim?')) return;
  }

  clientes.push({ contrato, nome, celular, data, periodo:'', endereco, bairro, status:'Aguardando' });
  salvarLocal(); atualizarTabela();
  // limpa campos
  document.getElementById('inputCliente').value=''; document.getElementById('inputCelular').value='';
  document.getElementById('inputContrato').value=''; document.getElementById('inputData').value='';
  document.getElementById('inputEndereco').value=''; document.getElementById('inputBairro').value='';
}

/* ================= Atualizar tabela (com filtro por contrato) ================= */
function atualizarTabela(){
  const tbody = document.querySelector('#tabela tbody');
  tbody.innerHTML = '';
  const filtro = (document.getElementById('filtroContrato').value || '').toString().trim().toLowerCase();
  clientes.forEach((c, i) => {
    if(filtro && (!e(c.contrato).toLowerCase().includes(filtro) && !e(c.nome).toLowerCase().includes(filtro))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="sel-col checkbox-center"><input type="checkbox" class="sel" data-i="${i}"></td>
      <td contenteditable="true" onblur="editarCampo(${i}, 'contrato', this.innerText)">${escapeHtml(c.contrato)}</td>
      <td contenteditable="true" onblur="editarCampo(${i}, 'nome', this.innerText)">${escapeHtml(c.nome)}</td>
      <td contenteditable="true" onblur="editarCelular(${i}, this.innerText)">${escapeHtml(c.celular)}</td>
      <td><input type="date" value="${escapeHtml(c.data||'')}" onchange="editarCampo(${i}, 'data', this.value)"></td>
      <td>
        <select onchange="editarCampo(${i}, 'periodo', this.value)">
          <option value="">‚Äî</option>
          <option ${c.periodo==='Manh√£'?'selected':''}>Manh√£</option>
          <option ${c.periodo==='Tarde'?'selected':''}>Tarde</option>
          <option ${c.periodo==='Noite'?'selected':''}>Noite</option>
        </select>
      </td>
      <td contenteditable="true" onblur="editarCampo(${i}, 'endereco', this.innerText)">${escapeHtml(c.endereco)}</td>
      <td contenteditable="true" onblur="editarCampo(${i}, 'bairro', this.innerText)">${escapeHtml(c.bairro)}</td>
      <td>${escapeHtml(c.status)}</td>
      <td class="actions">
        <button onclick="enviarPara(${i})" title="Enviar">üì§</button>
        <button onclick="atualizarStatus(${i}, 'Confirmado')" title="Confirmado">‚úÖ</button>
        <button onclick="atualizarStatus(${i}, 'Reagendado')" title="Reagendado">üìÖ</button>
        <button onclick="atualizarStatus(${i}, 'Cancelado')" title="Cancelado">‚ùå</button>
        <button onclick="excluirCliente(${i})" title="Excluir">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  atualizarContadores();
}

/* ================= Edi√ß√£o e a√ß√µes ================= */
function editarCampo(i, campo, valor){ clientes[i][campo] = (valor||'').toString().trim(); salvarLocal(); }
function editarCelular(i, valor){ clientes[i].celular = (valor||'').replace(/\D/g,''); salvarLocal(); }
function atualizarStatus(i, novo){ clientes[i].status = novo; salvarLocal(); atualizarTabela(); }
function excluirCliente(i){ if(confirm('Excluir este registro?')){ clientes.splice(i,1); salvarLocal(); atualizarTabela(); } }
function limparTodos(){ if(confirm('Apagar todos os registros?')){ clientes=[]; salvarLocal(); atualizarTabela(); } }

/* ================= Contadores coloridos atualizando ao vivo ================= */
function atualizarContadores(){
  let aguard=0, conf=0, re=0, can=0;
  clientes.forEach(c=>{
    if(c.status === 'Confirmado') conf++;
    else if(c.status === 'Reagendado') re++;
    else if(c.status === 'Cancelado') can++;
    else aguard++;
  });
  document.getElementById('contAguardando').textContent = aguard;
  document.getElementById('contConfirmado').textContent = conf;
  document.getElementById('contReagendado').textContent = re;
  document.getElementById('contCancelado').textContent = can;
}

/* ================= Mensagens (3 modelos) ================= */
function atualizarMensagemPadrao(){
  const tipo = document.getElementById('tipoMensagem').value;
  if(tipo==='antecipacao'){
    document.getElementById('mensagemPadrao').value =
`Ol√°, Prezado(a) [NOME]!

Aqui √© da Ligga Telecom, tudo bem? üòä

Identificamos a possibilidade de antecipar o seu atendimento para hoje!

üìÖ Data: [DATA]
‚è∞ Per√≠odo: [PERIODO]

Voc√™ confirma a antecipa√ß√£o do seu atendimento?
1Ô∏è‚É£ SIM, CONFIRMAR
2Ô∏è‚É£ N√ÉO, MANTER DATA ATUAL

(Nosso sistema n√£o suporta chamadas ou √°udios)`;
  } else if(tipo==='confirmacao'){
    document.getElementById('mensagemPadrao').value =
`Ol√°, tudo bem?

Meu contato √© referente √† Confirma√ß√£o de Agendamento ‚Äì Instala√ß√£o de Internet | Ligga Telecom.

üìÖ Agendado: [DATA] - [PERIODO]

Por favor, selecione uma das op√ß√µes abaixo para que possamos dar andamento:

1Ô∏è‚É£ Confirmar atendimento
2Ô∏è‚É£ Preciso reagendar
3Ô∏è‚É£ J√° cancelei os servi√ßos

Obs.: Nosso sistema n√£o aceita √°udios ou chamadas telef√¥nicas.

Aguardamos sua resposta!
Equipe Ligga Telecom`;
  } else {
    document.getElementById('mensagemPadrao').value =
`Ol√°, [NOME]!

Aqui √© da Ligga Telecom. Informamos que nosso t√©cnico est√° em frente ao seu endere√ßo para realizar a visita t√©cnica. üöÄ

Endere√ßo: [ENDERECO]

‚ö†Ô∏è Por favor, certifique-se de que haja algu√©m maior de 18 anos no local durante o atendimento. ‚ö†Ô∏è

Agradecemos a sua aten√ß√£o!
Equipe Ligga Telecom`;
  }
}

/* monta mensagem personalizada */
function montarMensagem(c){
  const tpl = document.getElementById('mensagemPadrao').value || '';
  return tpl.replaceAll('[NOME]', e(c.nome))
            .replaceAll('[DATA]', e(formatDateForMessage(c.data)))
            .replaceAll('[PERIODO]', e(c.periodo||'‚Äî'))
            .replaceAll('[ENDERECO]', e(c.endereco))
            .replaceAll('[CONTRATO]', e(c.contrato))
            .replaceAll('[BAIRRO]', e(c.bairro));
}

/* ================= Envio WhatsApp ================= */
function enviarPara(i){
  const c = clientes[i];
  const numero = (c.celular||'').replace(/\D/g,'');
  if(!numero) return alert('N√∫mero inv√°lido para este cliente.');
  const msg = montarMensagem(c);
  const mesma = document.getElementById('usarMesmaAba').checked;
  const target = mesma ? 'whatsapp' : '_blank';
  window.open(`https://web.whatsapp.com/send?phone=55${numero}&text=${encodeURIComponent(msg)}`, target);
  c.status = 'Mensagem enviada';
  salvarLocal(); setTimeout(()=>atualizarTabela(),300);
}

function enviarSelecionados(){
  const checks = Array.from(document.querySelectorAll('.sel:checked'));
  if(checks.length === 0) return alert('Selecione ao menos um contrato.');
  const mesma = document.getElementById('usarMesmaAba').checked;
  const target = mesma ? 'whatsapp' : '_blank';
  checks.forEach(ch=>{
    const i = parseInt(ch.dataset.i,10);
    const c = clientes[i];
    const numero = (c.celular||'').replace(/\D/g,'');
    if(!numero) return;
    const msg = montarMensagem(c);
    window.open(`https://web.whatsapp.com/send?phone=55${numero}&text=${encodeURIComponent(msg)}`, target);
    c.status = 'Mensagem enviada';
  });
  salvarLocal(); setTimeout(()=>atualizarTabela(),400);
}

/* ================= Selecionar todos / Limpar selecionados ================= */
let todosSelecionados = false;
function selecionarTodosToggle(){
  todosSelecionados = !todosSelecionados;
  document.querySelectorAll('.sel').forEach(ch => ch.checked = todosSelecionados);
}
function toggleSelecionarTodosTop(el){
  const checked = el.checked;
  document.querySelectorAll('.sel').forEach(ch => ch.checked = checked);
}
function limparSelecionados(){
  const checks = Array.from(document.querySelectorAll('.sel:checked'));
  if(checks.length === 0) return alert('Nenhum selecionado.');
  if(!confirm(`Excluir ${checks.length} registros selecionados?`)) return;
  const indices = checks.map(ch => parseInt(ch.dataset.i,10)).sort((a,b)=>b-a);
  indices.forEach(idx => clientes.splice(idx,1));
  salvarLocal(); atualizarTabela();
}

/* ================= Importar CSV (formato confirmado) ================= */
function importarCSV(event){
  const f = event.target.files && event.target.files[0];
  if(!f) return;
  Papa.parse(f, {
    header: true,
    skipEmptyLines: true,
    complete: function(res){
      const rows = res.data || [];
      let added = 0;
      rows.forEach(r=>{
        const contratoRaw = (r['Contrato'] || r['contrato'] || '').toString().trim();
        const nomeRaw = (r['Cliente'] || r['cliente'] || r['Nome'] || '').toString().trim();
        const celularRaw = (r['Celular'] || r['celular'] || r['Telefone'] || '').toString().replace(/\D/g,'').trim();
        const dataRaw = (r['Data Agendamento'] || r['Data'] || r['data'] || '').toString().trim();
        const enderecoRaw = (r['Endere√ßo'] || r['Endereco'] || r['endereco'] || '').toString().trim();
        const bairroRaw = (r['Bairro'] || r['bairro'] || '').toString().trim();

        if(!contratoRaw && !nomeRaw && !celularRaw) return;
        if(contratoRaw && clientes.some(x => x.contrato === contratoRaw)) return;

        const dataIso = parseDateCSV(dataRaw);
        clientes.push({
          contrato: contratoRaw,
          nome: nomeRaw,
          celular: celularRaw,
          data: dataIso,
          periodo: '',
          endereco: enderecoRaw,
          bairro: bairroRaw,
          status: 'Aguardando'
        });
        added++;
      });
      salvarLocal(); atualizarTabela();
      alert(`Importa√ß√£o conclu√≠da ‚Äî ${added} registros adicionados.`);
    },
    error: function(err){ alert('Erro ao importar CSV: ' + (err.message || err)); }
  });
}

/* ================= Exportar CSV (selecionados ou todos) sem duplicados por contrato ================= */
function exportarCSV(){
  const checks = Array.from(document.querySelectorAll('.sel:checked'));
  let lista = [];
  if(checks.length>0){
    lista = checks.map(ch => clientes[parseInt(ch.dataset.i,10)]);
  } else {
    lista = clientes.slice();
  }
  const unicos = lista.filter((c, idx, arr) => { if(!c.contrato) return true; return arr.findIndex(x => x.contrato === c.contrato) === idx; });
  if(unicos.length===0) return alert('Nada para exportar.');
  const header = ['Contrato','Cliente','Celular','Data Agendamento','Per√≠odo','Endere√ßo','Bairro','Status'];
  const lines = [header.join(',')];
  unicos.forEach(c=>{
    const dataOut = formatDateForMessage(c.data);
    const row = [c.contrato, c.nome, c.celular, dataOut, c.periodo, c.endereco, c.bairro, c.status].map(v => `"${(e(v)).replace(/"/g,'""')}"`).join(',');
    lines.push(row);
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'relatorio_atendimento_cop.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ================= Filtro por contrato (input) ================= */
function filtrarTabela(){
  atualizarTabela();
}

/* expose for debugging if needed */
window._clientes = clientes;
</script>
</body>
</html>
