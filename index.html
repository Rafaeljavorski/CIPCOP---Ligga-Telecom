<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atendimento COT - Ligga Telecom</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial; background:#f9fafb; margin:20px; color:#333; }
h1{text-align:center;color:#2563eb;}
.input-area, table{width:100%; max-width:1200px; margin:20px auto;}
input, select, button, textarea{padding:6px;margin:4px;border:1px solid #ccc;border-radius:6px;}
button{cursor:pointer;background-color:#2563eb;color:white;border:none;}
button:hover{background-color:#1e40af;}
table{border-collapse:collapse;width:100%;background:white;border-radius:10px;overflow:hidden;}
th,td{border:1px solid #ddd;padding:6px;text-align:center;}
th{background-color:#2563eb;color:white;}
tr:nth-child(even){background-color:#f2f2f2;}
.top-buttons{text-align:center;margin-bottom:20px;}
.stats{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;max-width:600px;margin:0 auto 20px;}
.card{flex:1;min-width:120px;background:white;border-radius:12px;padding:8px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.confirmado {border-top:4px solid #22c55e;}
.reagendado {border-top:4px solid #facc15;}
.cancelado {border-top:4px solid #ef4444;}
.aguardando {border-top:4px solid #3b82f6;}
textarea{width:100%; min-height:60px;}
</style>
</head>
<body>

<h1>Atendimento COT - Ligga Telecom</h1>

<div class="stats">
  <div class="card aguardando"><strong>Aguardando</strong><p id="contAguardando">0</p></div>
  <div class="card confirmado"><strong>Confirmados</strong><p id="contConfirmado">0</p></div>
  <div class="card reagendado"><strong>Reagendados</strong><p id="contReagendado">0</p></div>
  <div class="card cancelado"><strong>Cancelados</strong><p id="contCancelado">0</p></div>
</div>

<div class="input-area">
  <input id="cliente" placeholder="Nome do cliente">
  <input id="celular" placeholder="Celular (somente n√∫meros)">
  <input id="contrato" placeholder="N√∫mero do Contrato">
  <input id="data" type="date">
  <select id="periodo">
    <option value="">Per√≠odo</option>
    <option>Manh√£</option>
    <option>Tarde</option>
    <option>Noite</option>
  </select>
  <input id="endereco" placeholder="Endere√ßo do cliente">
  <input id="bairro" placeholder="Bairro">
  <button onclick="adicionarCliente()">Adicionar</button>

  <select id="tipoMensagem" onchange="atualizarMensagemPadrao()">
    <option value="antecipacao">Mensagem de Antecipa√ß√£o</option>
    <option value="confirmacao">Mensagem de Confirma√ß√£o</option>
    <option value="chegada">Aviso Chegada T√©cnico</option>
  </select>

  <textarea id="mensagemPadrao" placeholder="Mensagem para envio"></textarea>
  
  <div class="top-buttons">
    <button onclick="document.getElementById('arquivoCSV').click()">üì• Importar CSV</button>
    <input type="file" id="arquivoCSV" accept=".csv" style="display:none" onchange="importarCSV(event)">
    <button onclick="exportarCSV()">üìä Exportar Relat√≥rio (Sem Duplicados)</button>
  </div>
</div>

<table id="tabela">
  <thead>
    <tr>
      <th>Cliente</th>
      <th>Celular</th>
      <th>Contrato</th>
      <th>Data</th>
      <th>Per√≠odo</th>
      <th>Endere√ßo</th>
      <th>Bairro</th>
      <th>Status</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
let clientes = [];

function salvarLocal() { localStorage.setItem('clientes', JSON.stringify(clientes)); }
function carregarLocal() { const data = localStorage.getItem('clientes'); if(data){ clientes = JSON.parse(data); atualizarTabela(); } }
window.onload = () => { carregarLocal(); atualizarMensagemPadrao(); };

function adicionarCliente() {
  const nome = document.getElementById('cliente').value;
  const celular = document.getElementById('celular').value;
  const contrato = document.getElementById('contrato').value;
  const data = document.getElementById('data').value;
  const periodo = document.getElementById('periodo').value;
  const endereco = document.getElementById('endereco').value;
  const bairro = document.getElementById('bairro').value;
  if (!nome || !celular || !contrato || !data || !periodo || !endereco || !bairro) { alert("Preencha todos os campos!"); return; }
  clientes.push({ nome, celular, contrato, data, periodo, endereco, bairro, status:"Aguardando" });
  atualizarTabela(); limparCampos(); salvarLocal();
}
function limparCampos(){
  document.getElementById('cliente').value = "";
  document.getElementById('celular').value = "";
  document.getElementById('contrato').value = "";
  document.getElementById('data').value = "";
  document.getElementById('periodo').value = "";
  document.getElementById('endereco').value = "";
  document.getElementById('bairro').value = "";
}

// --- Mensagens din√¢micas ---
function gerarMensagem(c){
  const tipo = document.getElementById('tipoMensagem').value;
  if(tipo==="antecipacao"){
    return `Ol√°, Prezado(a) ${c.nome}!\n\nAqui √© da Ligga Telecom, tudo bem? üòä\n\nIdentificamos a possibilidade de antecipar o seu atendimento para hoje!\n\nüìÖ Data: ${c.data}\n‚è∞ Per√≠odo: ${c.periodo}\n\nVoc√™ confirma a antecipa√ß√£o do seu atendimento? ‚úÖ\n1. SIM, CONFIRMAR\n2. N√ÉO, MANTER DATA ATUAL\n\n(Nosso sistema n√£o suporta chamadas ou √°udios)`;
  } else if(tipo==="confirmacao"){
    return `Ol√°, tudo bem?\n\nMeu contato √© referente √† Confirma√ß√£o de Agendamento ‚Äì Instala√ß√£o de Internet | Ligga Telecom.\n\nüìÖ Agendado: ${c.data}\n\nPor favor, selecione uma das op√ß√µes abaixo para que possamos dar andamento:\n1Ô∏è‚É£ Confirmar atendimento\n2Ô∏è‚É£ Preciso reagendar\n3Ô∏è‚É£ J√° cancelei os servi√ßos\n\nObs.: Nosso sistema n√£o aceita √°udios ou chamadas telef√¥nicas.\n\nAguardamos sua resposta!\nEquipe Ligga Telecom\n\nUm t√©cnico a servi√ßo da Ligga Telecom est√° a caminho da sua resid√™ncia para realizar a visita t√©cnica.\n\n‚ö†Ô∏è Pedimos que haja algu√©m maior de 18 anos no local durante o atendimento. ‚ö†Ô∏è`;
  } else if(tipo==="chegada"){
    return `Ol√°, ${c.nome}!\n\nAqui √© da Ligga Telecom. Informamos que nosso t√©cnico est√° em frente ao seu endere√ßo para realizar a visita t√©cnica. üöÄ\n\n‚ö†Ô∏è Por favor, certifique-se que haja algu√©m maior de 18 anos no local durante o atendimento. ‚ö†Ô∏è\n\nAgradecemos a sua aten√ß√£o!\nEquipe Ligga Telecom`;
  }
}

function atualizarMensagemPadrao(){
  const c = {nome:"Cliente",data:"dd/mm/aaaa",periodo:"Per√≠odo"};
  document.getElementById('mensagemPadrao').value = gerarMensagem(c);
}

// --- Atualizar tabela ---
function atualizarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  clientes.forEach((c,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.nome}</td>
      <td contenteditable="true" onblur="alterarNumero(${i},this.innerText)">${c.celular}</td>
      <td contenteditable="true" onblur="alterarContrato(${i},this.innerText)">${c.contrato}</td>
      <td>${c.data}</td>
      <td>${c.periodo}</td>
      <td contenteditable="true" onblur="alterarEndereco(${i},this.innerText)">${c.endereco}</td>
      <td contenteditable="true" onblur="alterarBairro(${i},this.innerText)">${c.bairro}</td>
      <td>${c.status}</td>
      <td>
        <button onclick="enviarMensagem(${i})">üì§ Enviar Mensagem</button>
        <button onclick="atualizarStatus(${i},'Confirmado')">‚úÖ Confirmar</button>
        <button onclick="atualizarStatus(${i},'Reagendado')">üìÖ Reagendar</button>
        <button onclick="atualizarStatus(${i},'Cancelado')">‚ùå Cancelar</button>
        <button onclick="excluirContato(${i})">üóëÔ∏è Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
  atualizarContadores(); salvarLocal();
}

// --- Fun√ß√µes de edi√ß√£o ---
function alterarNumero(i, numero){ clientes[i].celular = numero; salvarLocal(); }
function alterarContrato(i, valor){ clientes[i].contrato = valor; salvarLocal(); }
function alterarEndereco(i,endereco){ clientes[i].endereco=endereco; salvarLocal(); }
function alterarBairro(i, bairro){ clientes[i].bairro = bairro; salvarLocal(); }
function atualizarStatus(i,status){ clientes[i].status=status; atualizarTabela(); salvarLocal(); }
function excluirContato(i){ if(confirm("Deseja realmente excluir este contato?")){ clientes.splice(i,1); atualizarTabela(); salvarLocal(); } }

// --- Contadores ---
function atualizarContadores(){
  const cont={aguardando:0,confirmado:0,reagendado:0,cancelado:0};
  clientes.forEach(c=>{
    if(c.status.includes("Aguardando") || c.status=="Mensagem enviada") cont.aguardando++;
    else if(c.status=="Confirmado") cont.confirmado++;
    else if(c.status=="Reagendado") cont.reagendado++;
    else if(c.status=="Cancelado") cont.cancelado++;
  });
  document.getElementById("contAguardando").innerText=cont.aguardando;
  document.getElementById("contConfirmado").innerText=cont.confirmado;
  document.getElementById("contReagendado").innerText=cont.reagendado;
  document.getElementById("contCancelado").innerText=cont.cancelado;
}

// --- Envio individual ---
function enviarMensagem(i){
  const c = clientes[i];
  const numero = c.celular;
  const msg = c.mensagem || gerarMensagem(c);
  window.open(`https://web.whatsapp.com/send?phone=55${numero}&text=${encodeURIComponent(msg)}`, "_blank");
  c.status = "Mensagem enviada";
  atualizarTabela(); salvarLocal();
}

// --- CSV ---
function exportarCSV(){
  // Filtra duplicados pelo n√∫mero do contrato
  const clientesUnicos = clientes.filter((c, index, self) =>
    index === self.findIndex(t => t.contrato === c.contrato)
  );

  let csv = "Cliente,Celular,Contrato,Data,Per√≠odo,Endere√ßo,Bairro,Status\n";
  clientesUnicos.forEach(c => {
    const linha = [
      `"${c.nome}"`,
      `"${c.celular}"`,
      `"${c.contrato}"`,
      `"${c.data}"`,
      `"${c.periodo}"`,
      `"${c.endereco}"`,
      `"${c.bairro}"`,
      `"${c.status}"`
    ].join(",");
    csv += linha + "\n";
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.setAttribute("href", URL.createObjectURL(blob));
  link.setAttribute("download", "relatorio_visitas.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// --- Importar CSV ---
function importarCSV(event){
  const file=event.target.files[0]; if(!file) return;
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(results){
    results.data.forEach(row=>{
      if(row.Nome && row.Celular){
        clientes.push({
          nome: row.Nome || row.nome || "",
          celular: row.Celular || row.celular || "",
          contrato: row.Contrato || row.contrato || "",
          data: row.Data || row.data || "",
          periodo: row.Periodo || row.periodo || "",
          endereco: row.Endereco || row.endereco || "",
          bairro: row.Bairro || row.bairro || "",
          status: "Importado"
        });
      }
    }); atualizarTabela(); salvarLocal();
  }});
}
</script>
</body>
</html>
